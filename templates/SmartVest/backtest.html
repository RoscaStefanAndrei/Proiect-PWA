{% extends "base.html" %}

{% block title %}Backtesting{% endblock %}
{% block header_title %}üìä Backtesting Engine{% endblock %}

{% block content %}
<style>
    .backtest-card {
        background: linear-gradient(135deg, #131622 0%, #1a1f2e 100%);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 32px;
    }

    .param-label {
        color: #8da3b6;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .form-select,
    .form-control {
        background-color: #0b0f19 !important;
        border: 1px solid rgba(255, 255, 255, 0.15) !important;
        color: #fff !important;
        border-radius: 10px;
        padding: 12px 16px;
        font-size: 1rem;
    }

    .form-select:focus,
    .form-control:focus {
        border-color: #28a745 !important;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.15) !important;
    }

    .btn-backtest {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: #fff;
        font-weight: 700;
        font-size: 1.1rem;
        padding: 14px 40px;
        border-radius: 12px;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .btn-backtest:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.35);
        color: #fff;
    }

    .btn-backtest:disabled {
        opacity: 0.6;
        transform: none;
        cursor: not-allowed;
    }

    /* Progress bar */
    .progress-container {
        display: none;
        margin-top: 24px;
    }

    .progress-container.active {
        display: block;
    }

    .progress-bar-wrapper {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        overflow: hidden;
        height: 28px;
        position: relative;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745 0%, #20c997 50%, #28a745 100%);
        background-size: 200% 100%;
        animation: shimmer 2s infinite linear;
        border-radius: 12px;
        transition: width 0.5s ease-out;
        width: 0%;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 40px;
    }

    @keyframes shimmer {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }

    .progress-percent {
        font-size: 0.8rem;
        font-weight: 700;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .progress-message {
        color: #8da3b6;
        font-size: 0.9rem;
        margin-top: 10px;
        font-style: italic;
    }

    .progress-steps {
        margin-top: 16px;
        padding: 16px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        max-height: 200px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        color: #6c7a89;
    }

    .progress-steps .step {
        padding: 2px 0;
    }

    .progress-steps .step.current {
        color: #28a745;
        font-weight: bold;
    }

    /* Results section */
    .results-section {
        margin-top: 40px;
    }

    .metric-card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s;
    }

    .metric-card:hover {
        border-color: rgba(40, 167, 69, 0.3);
        transform: translateY(-2px);
    }

    .metric-value {
        font-size: 1.8rem;
        font-weight: 800;
        margin-bottom: 4px;
    }

    .metric-value.positive {
        color: #28a745;
    }

    .metric-value.negative {
        color: #dc3545;
    }

    .metric-value.neutral {
        color: #ffc107;
    }

    .metric-label {
        color: #8da3b6;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .chart-container {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 24px;
        margin-top: 20px;
    }

    .chart-container canvas {
        width: 100% !important;
        max-height: 400px;
    }

    .snapshot-table {
        font-size: 0.85rem;
    }

    .snapshot-table th {
        color: #8da3b6;
        border-color: rgba(255, 255, 255, 0.1);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
    }

    .snapshot-table td {
        border-color: rgba(255, 255, 255, 0.05);
        vertical-align: middle;
    }

    .badge-ticker {
        background: rgba(40, 167, 69, 0.15);
        color: #28a745;
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        margin: 2px;
        display: inline-block;
    }

    .profile-badge {
        display: inline-block;
        padding: 4px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .profile-badge.conservative {
        background: rgba(23, 162, 184, 0.2);
        color: #17a2b8;
    }

    .profile-badge.balanced {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }

    .profile-badge.aggressive {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<div class="row">
    <div class="col-lg-10 mx-auto">

        <!-- Config Form -->
        <div class="backtest-card mb-4">
            <div class="d-flex align-items-center mb-4">
                <i class="fas fa-flask text-success fs-3 me-3"></i>
                <div>
                    <h4 class="mb-0 fw-bold">Backtesting Engine</h4>
                    <small class="text-muted">TesteazƒÉ algoritmul pe date istorice</small>
                </div>
            </div>

            <form id="backtestForm" method="post">
                {% csrf_token %}
                <div class="row g-4">
                    <div class="col-md-3">
                        <div class="param-label">PerioadƒÉ</div>
                        <select name="period" class="form-select" id="periodSelect">
                            <option value="1">1 An</option>
                            <option value="2" selected>2 Ani</option>
                            <option value="3">3 Ani</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <div class="param-label">Profil Investi»õie</div>
                        <select name="profile_type" class="form-select" id="profileSelect">
                            <option value="conservative">üõ°Ô∏è Conservative</option>
                            <option value="balanced" selected>‚öñÔ∏è Balanced</option>
                            <option value="aggressive">üî• Aggressive</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <div class="param-label">Capital Ini»õial ($)</div>
                        <input type="number" name="initial_capital" class="form-control" value="10000" min="1000"
                            max="10000000" step="1000" id="capitalInput">
                    </div>

                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-backtest w-100" id="runBtn">
                            <i class="fas fa-play me-2"></i>Run Backtest
                        </button>
                    </div>
                </div>
            </form>

            <!-- Progress Bar -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar-wrapper">
                    <div class="progress-bar-fill" id="progressBar">
                        <span class="progress-percent" id="progressPercent">0%</span>
                    </div>
                </div>
                <div class="progress-message" id="progressMessage">Se ini»õializeazƒÉ...</div>
                <div class="progress-steps" id="progressLog"></div>
            </div>
        </div>

        <!-- Results (rendered if available) -->
        {% if result %}
        <div class="results-section" id="resultsSection">

            <!-- Summary Header -->
            <div class="backtest-card mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-chart-line text-success me-2"></i>Rezultate Backtest
                    </h5>
                    <div>
                        <span class="profile-badge {{ result.profile_type }}">{{ result.profile_type }}</span>
                        <span class="text-muted ms-3">{{ result.start_date }} ‚Üí {{ result.end_date }}</span>
                    </div>
                </div>

                <!-- Metrics Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <div class="metric-card">
                            <div
                                class="metric-value {% if result.metrics.total_return >= 0 %}positive{% else %}negative{% endif %}">
                                {{ result.metrics.total_return|floatformat:1 }}%
                            </div>
                            <div class="metric-label">Randament Total</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="metric-card">
                            <div
                                class="metric-value {% if result.metrics.cagr >= 0 %}positive{% else %}negative{% endif %}">
                                {{ result.metrics.cagr|floatformat:1 }}%
                            </div>
                            <div class="metric-label">CAGR</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="metric-card">
                            <div class="metric-value neutral">
                                {{ result.metrics.sharpe_ratio|floatformat:2 }}
                            </div>
                            <div class="metric-label">Sharpe Ratio</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="metric-card">
                            <div class="metric-value negative">
                                {{ result.metrics.max_drawdown|floatformat:1 }}%
                            </div>
                            <div class="metric-label">Max Drawdown</div>
                        </div>
                    </div>
                </div>

                <!-- Second row of metrics -->
                <div class="row g-3">
                    <div class="col-6 col-md-2">
                        <div class="metric-card">
                            <div class="metric-value" style="font-size:1.3rem; color:#17a2b8;">
                                ${{ result.metrics.final_value|floatformat:0 }}
                            </div>
                            <div class="metric-label">Valoare FinalƒÉ</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="metric-card">
                            <div class="metric-value neutral" style="font-size:1.3rem;">
                                {{ result.metrics.annual_volatility|floatformat:1 }}%
                            </div>
                            <div class="metric-label">Volatilitate</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="metric-card">
                            <div class="metric-value" style="font-size:1.3rem; color:#6f42c1;">
                                {{ result.metrics.sortino_ratio|floatformat:2 }}
                            </div>
                            <div class="metric-label">Sortino</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="metric-card">
                            <div class="metric-value" style="font-size:1.3rem; color:#fd7e14;">
                                {{ result.metrics.calmar_ratio|floatformat:2 }}
                            </div>
                            <div class="metric-label">Calmar</div>
                        </div>
                    </div>
                    {% if result.metrics.alpha is not None %}
                    <div class="col-6 col-md-2">
                        <div class="metric-card">
                            <div class="metric-value {% if result.metrics.alpha >= 0 %}positive{% else %}negative{% endif %}"
                                style="font-size:1.3rem;">
                                {{ result.metrics.alpha|floatformat:1 }}%
                            </div>
                            <div class="metric-label">Alpha</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="metric-card">
                            <div class="metric-value" style="font-size:1.3rem; color:#8da3b6;">
                                {{ result.metrics.beta|floatformat:2 }}
                            </div>
                            <div class="metric-label">Beta</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Equity Curve Chart -->
            <div class="chart-container">
                <h6 class="fw-bold mb-3">
                    <i class="fas fa-chart-area text-success me-2"></i>
                    Evolu»õia Portofoliului vs S&P 500
                </h6>
                <canvas id="equityChart"></canvas>
            </div>

            <!-- Drawdown Chart -->
            <div class="chart-container">
                <h6 class="fw-bold mb-3">
                    <i class="fas fa-chart-bar text-danger me-2"></i>
                    Drawdown
                </h6>
                <canvas id="drawdownChart"></canvas>
            </div>

            <!-- Portfolio Snapshots -->
            {% if result.snapshots %}
            <div class="backtest-card mt-4">
                <h6 class="fw-bold mb-3">
                    <i class="fas fa-sync-alt text-success me-2"></i>
                    RebalansƒÉri ({{ result.snapshots|length }})
                </h6>
                <div class="table-responsive">
                    <table class="table table-dark snapshot-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Valoare Portofoliu</th>
                                <th>Nr. Ac»õiuni</th>
                                <th>AlocƒÉri</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for snap in result.snapshots %}
                            <tr>
                                <td class="fw-bold">{{ snap.date }}</td>
                                <td>${{ snap.portfolio_value|floatformat:0 }}</td>
                                <td>{{ snap.n_stocks }}</td>
                                <td>
                                    {% for ticker, weight in snap.allocations.items %}
                                    <span class="badge-ticker">{{ ticker }} {{ weight|floatformat:0 }}%</span>
                                    {% empty %}
                                    <span class="text-muted">Cash</span>
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Benchmark comparison box -->
            {% if result.metrics.benchmark_return is not None %}
            <div class="backtest-card mt-4">
                <h6 class="fw-bold mb-3">
                    <i class="fas fa-balance-scale text-info me-2"></i>
                    Compara»õie cu S&P 500
                </h6>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="metric-card">
                            <div
                                class="metric-value {% if result.metrics.total_return >= 0 %}positive{% else %}negative{% endif %}">
                                {{ result.metrics.total_return|floatformat:1 }}%
                            </div>
                            <div class="metric-label">Portofoliu SmartVest</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card">
                            <div class="metric-value" style="color: #ffc107;">
                                {{ result.metrics.benchmark_return|floatformat:1 }}%
                            </div>
                            <div class="metric-label">S&P 500 (SPY)</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card">
                            <div
                                class="metric-value {% if result.metrics.outperformance >= 0 %}positive{% else %}negative{% endif %}">
                                {% if result.metrics.outperformance >= 0 %}+{% endif %}{{
                                result.metrics.outperformance|floatformat:1 }}%
                            </div>
                            <div class="metric-label">Supraperforman»õƒÉ</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Disclaimer -->
            {% if result.disclaimer %}
            <div class="backtest-card mt-4" style="border-color: rgba(255, 193, 7, 0.2);">
                <div class="d-flex align-items-start">
                    <i class="fas fa-exclamation-triangle text-warning me-3 mt-1"></i>
                    <div>
                        <h6 class="fw-bold mb-2" style="color: #ffc107;">LimitƒÉri Metodologice</h6>
                        <p class="text-muted mb-0" style="font-size: 0.85rem; line-height: 1.6;">
                            {{ result.disclaimer }}
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}

        </div>
        {% endif %}

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('backtestForm');
        const runBtn = document.getElementById('runBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const progressMessage = document.getElementById('progressMessage');
        const progressLog = document.getElementById('progressLog');

        let pollInterval = null;

        form.addEventListener('submit', function (e) {
            // Show progress bar
            progressContainer.classList.add('active');
            runBtn.disabled = true;
            runBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Se ruleazƒÉ...';

            // Start polling for progress
            pollInterval = setInterval(pollProgress, 1500);
        });

        function pollProgress() {
            fetch('{% url "backtest-progress" %}')
                .then(response => response.json())
                .then(data => {
                    updateProgress(data.percent || 0, data.message || 'Se proceseazƒÉ...');

                    if (data.percent >= 100) {
                        clearInterval(pollInterval);
                        // Page will reload with results from the form POST
                    }
                })
                .catch(err => {
                    console.log('Progress poll error:', err);
                });
        }

        function updateProgress(percent, message) {
            progressBar.style.width = percent + '%';
            progressPercent.textContent = Math.round(percent) + '%';
            progressMessage.textContent = message;

            // Add to log
            const step = document.createElement('div');
            step.className = 'step current';
            step.textContent = `[${Math.round(percent)}%] ${message}`;
            progressLog.appendChild(step);
            progressLog.scrollTop = progressLog.scrollHeight;

            // Remove "current" from previous steps
            const steps = progressLog.querySelectorAll('.step.current');
            if (steps.length > 1) {
                for (let i = 0; i < steps.length - 1; i++) {
                    steps[i].classList.remove('current');
                }
            }
        }

        // --- CHARTS ---
        {% if result and result.equity_curve %}
        // Equity Curve
        const equityCtx = document.getElementById('equityChart').getContext('2d');
        new Chart(equityCtx, {
            type: 'line',
            data: {
                labels: {{ result.equity_curve.dates | safe }},
        datasets: [
        {
            label: 'Portofoliu SmartVest',
            data: {{ result.equity_curve.values | safe }},
        borderColor: '#28a745',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        fill: true,
        tension: 0.3,
        pointRadius: 0,
        borderWidth: 2.5,
                    },
        {% if result.benchmark_curve %}
    {
        label: 'S&P 500 (SPY)',
            data: {{ result.benchmark_curve.values|safe }},
        borderColor: '#ffc107',
            backgroundColor: 'rgba(255, 193, 7, 0.05)',
                fill: true,
                    tension: 0.3,
                        pointRadius: 0,
                            borderWidth: 2,
                                borderDash: [5, 3],
                    }
    {% endif %}
                ]
            },
    options: {
        responsive: true,
            maintainAspectRatio: true,
                aspectRatio: 2.5,
                    interaction: {
            intersect: false,
                mode: 'index',
                },
        plugins: {
            legend: {
                labels: { color: '#8da3b6', font: { size: 12 } }
            },
            tooltip: {
                backgroundColor: '#1a1f2e',
                    titleColor: '#fff',
                        bodyColor: '#8da3b6',
                            borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1,
                                    callbacks: {
                    label: function(ctx) {
                        return ctx.dataset.label + ': $' + ctx.parsed.y.toLocaleString();
                    }
                }
            }
        },
        scales: {
            x: {
                ticks: {
                    color: '#6c7a89',
                        maxTicksLimit: 12,
                            font: { size: 10 }
                },
                grid: { color: 'rgba(255,255,255,0.03)' }
            },
            y: {
                ticks: {
                    color: '#6c7a89',
                        callback: function(val) { return '$' + val.toLocaleString(); },
                    font: { size: 10 }
                },
                grid: { color: 'rgba(255,255,255,0.05)' }
            }
        }
    }
        });

    // Drawdown Chart
    const ddCtx = document.getElementById('drawdownChart').getContext('2d');

    // Calculate drawdown from equity curve
    const equityValues = {{ result.equity_curve.values| safe }};
    const equityDates = {{ result.equity_curve.dates| safe }};
    let runningMax = equityValues[0];
    const drawdownValues = equityValues.map(val => {
        if (val > runningMax) runningMax = val;
        return ((val / runningMax) - 1) * 100;
    });

    new Chart(ddCtx, {
        type: 'line',
        data: {
            labels: equityDates,
            datasets: [{
                label: 'Drawdown',
                data: drawdownValues,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.15)',
                fill: true,
                tension: 0.3,
                pointRadius: 0,
                borderWidth: 1.5,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 3,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1a1f2e',
                    titleColor: '#fff',
                    bodyColor: '#dc3545',
                    callbacks: {
                        label: function (ctx) {
                            return 'Drawdown: ' + ctx.parsed.y.toFixed(2) + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#6c7a89', maxTicksLimit: 12, font: { size: 10 } },
                    grid: { color: 'rgba(255,255,255,0.03)' }
                },
                y: {
                    ticks: {
                        color: '#6c7a89',
                        callback: function (val) { return val.toFixed(0) + '%'; },
                        font: { size: 10 }
                    },
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    max: 0,
                }
            }
        }
    });
    {% endif %}
});
</script>

{% endblock %}